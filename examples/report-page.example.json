{
  "title": "Fleet Activity Snapshot",
  "subtitle": "Live operational KPIs, charts, and inventory table",
  "meta": {
    "schema_version": "1.1.0",
    "report_id": "fleet-activity-snapshot",
    "slug": "fleet-activity-snapshot",
    "last_updated": "2025-10-24T00:00:00Z",
    "updated_by": { "id": "u_123", "name": "Danil Nezhdanov", "email": "danil@example.com" }
  },
  "datasources": [
    {
      "id": "navixy_pg",
      "driver": "postgres",
      "connection": { "env": "NAVIXY_PG_DSN" }
    }
  ],
  "parameters": [
    { "name": "tenant_id", "label": "Tenant", "type": "integer", "required": true },
    { "name": "start_date", "label": "Start date", "type": "date" },
    { "name": "end_date", "label": "End date", "type": "date" }
  ],
  "theme": { "bg_color": "#0B1220", "font_color": "#E7EEF7" },
  "rows": [
    {
      "type": "tiles",
      "title": "Today's KPIs",
      "visuals": [
        {
          "kind": "tile",
          "label": "Moving vehicles",
          "hint": "Current number of vehicles with speed > 0",
          "color": "#22C55E",
          "query": {
            "data_source_id": "navixy_pg",
            "sql": "SELECT COUNT(*) AS value FROM telemetry_vehicle_latest WHERE tenant_id = :tenant_id AND speed_kph > 0",
            "params": { "tenant_id": 101 }
          },
          "verify": {
            "row_count": { "eq": 1 },
            "columns": [{ "name": "value", "type": "integer" }],
            "value_checks": [{ "column": "value", "numeric_range": { "min": 0 } }]
          },
          "options": { "precision": 0 }
        },
        {
          "kind": "tile",
          "label": "Parked",
          "hint": "Vehicles with ignition off",
          "color": "#60A5FA",
          "query": {
            "data_source_id": "navixy_pg",
            "sql": "SELECT COUNT(*) AS value FROM telemetry_vehicle_latest WHERE tenant_id = :tenant_id AND ignition = false",
            "params": { "tenant_id": 101 }
          },
          "verify": { "row_count": { "eq": 1 }, "columns": [{ "name": "value", "type": "integer" }] }
        },
        {
          "kind": "tile",
          "label": "Offline",
          "hint": "No check-in in last 24h",
          "color": "#F59E0B",
          "query": {
            "data_source_id": "navixy_pg",
            "sql": "SELECT COUNT(*) AS value FROM telemetry_vehicle_latest WHERE tenant_id = :tenant_id AND last_seen_at < NOW() - INTERVAL '24 hours'",
            "params": { "tenant_id": 101 }
          },
          "verify": { "row_count": { "eq": 1 }, "columns": [{ "name": "value", "type": "integer" }] }
        }
      ]
    },

    {
      "type": "charts",
      "title": "Utilization & Composition",
      "visuals": [
        {
          "kind": "bar",
          "label": "Vehicles by status (Top 5)",
          "hint": "Counts of latest known status",
          "query": {
            "data_source_id": "navixy_pg",
            "sql": "SELECT status AS category, COUNT(*)::int AS value FROM telemetry_vehicle_latest WHERE tenant_id = :tenant_id GROUP BY status",
            "params": { "tenant_id": 101 }
          },
          "verify": {
            "row_count": { "min": 1 },
            "columns": [
              { "name": "category", "type": "string", "max_length": 64 },
              { "name": "value", "type": "integer" }
            ],
            "value_checks": [{ "column": "value", "numeric_range": { "min": 0 } }]
          },
          "options": {
            "category_field": "category",
            "value_field": "value",
            "orientation": "vertical",
            "sort_by": "value",
            "sort_dir": "desc",
            "top_n": 5,
            "show_value_labels": true,
            "precision": 0,
            "legend_position": "none",
            "palette": ["#22C55E", "#60A5FA", "#F59E0B", "#EF4444", "#14B8A6"]
          }
        },
        {
          "kind": "pie",
          "label": "Devices by model",
          "query": {
            "data_source_id": "navixy_pg",
            "sql": "SELECT COALESCE(model, 'Unknown') AS category, COUNT(*)::int AS value FROM fleet_vehicles WHERE tenant_id = :tenant_id GROUP BY 1",
            "params": { "tenant_id": 101 }
          },
          "verify": {
            "row_count": { "min": 1 },
            "columns": [
              { "name": "category", "type": "string", "max_length": 64, "nullable": true },
              { "name": "value", "type": "integer" }
            ],
            "value_checks": [{ "column": "value", "numeric_range": { "min": 0 } }]
          },
          "options": {
            "category_field": "category",
            "value_field": "value",
            "donut": true,
            "inner_radius": 0.55,
            "label_type": "percent",
            "precision": 1,
            "show_legend": true,
            "legend_position": "right",
            "palette": ["#60A5FA", "#22C55E", "#F59E0B", "#A78BFA", "#14B8A6", "#EF4444"]
          }
        }
      ]
    },

    {
      "type": "table",
      "title": "Inventory (Top 50 by last activity)",
      "subtitle": "Search and paginate to see all assets",
      "visuals": [
        {
          "kind": "table",
          "label": "Vehicles table",
          "hint": "Latest known state",
          "query": {
            "data_source_id": "navixy_pg",
            "row_limit": 50,
            "sql": "SELECT device_id, plate_number, model, last_seen_at, speed_kph, status FROM fleet_vehicles WHERE tenant_id = :tenant_id ORDER BY last_seen_at DESC LIMIT 200",
            "params": { "tenant_id": 101 }
          },
          "verify": {
            "row_count": { "min": 0 },
            "columns": [
              { "name": "device_id", "type": "string", "max_length": 64 },
              { "name": "plate_number", "type": "string", "max_length": 32, "nullable": true },
              { "name": "model", "type": "string", "max_length": 64, "nullable": true },
              { "name": "last_seen_at", "type": "datetime" },
              { "name": "speed_kph", "type": "number" },
              { "name": "status", "type": "string", "max_length": 32 }
            ],
            "value_checks": [
              { "column": "speed_kph", "numeric_range": { "min": 0 } },
              { "column": "status", "allowed_set": ["moving", "parked", "idle", "offline"] }
            ]
          },
          "options": {
            "paginate": true,
            "page_size": 25,
            "columns": [
              { "field": "device_id", "label": "Device", "align": "left" },
              { "field": "plate_number", "label": "Plate", "align": "left" },
              { "field": "model", "label": "Model", "align": "left" },
              { "field": "last_seen_at", "label": "Last seen", "format": "datetime" },
              { "field": "speed_kph", "label": "Speed", "format": "decimal", "precision": 1, "align": "right" },
              { "field": "status", "label": "Status" }
            ]
          }
        }
      ]
    },

    {
      "type": "annotation",
      "visuals": [
        {
          "kind": "annotation",
          "label": "Notes",
          "options": {
            "section_name": "Data notes",
            "subtitle": "Context for interpreting KPIs",
            "text": "KPIs use latest available telemetry. *Offline* counts devices without a check-in in the last 24 hours.",
            "markdown": true,
            "design": { "horizontal_rule": true, "bg_color": "#0F172A", "font_color": "#CBD5E1", "padding": "12px 16px" }
          }
        }
      ]
    }
  ]
}
